#!/usr/bin/env ruby
$stdout.sync = true

require "shellwords"
require "yaml"
load "./bin/webpack-env"

begin
  config              = YAML.load(File.read(CONFIG_PATH))[NODE_ENV]

  NODE_MODULES_PATH   = File.join(APP_PATH.shellescape, config["paths"]["node_modules_path"])
  WEBPACK_CONFIG_PATH = File.join(APP_PATH.shellescape, config["paths"]["config_path"])
  PACKS_PATH          = File.join(APP_PATH.shellescape, config["paths"]["dist_path"])
  WEBPACK_BIN         = "#{NODE_MODULES_PATH}/.bin/webpack-dev-server"
  DEV_SERVER_CONFIG   = "#{WEBPACK_CONFIG_PATH}/development.js"
rescue Errno::ENOENT, NoMethodError
  puts "config/webpacker.yml or [paths, dev_server] config not found."
  puts "Please run bundle exec rails webpacker:install to install webpacker"
  exit!
end

if __FILE__ == $0
  Dir.chdir(APP_PATH) do
    exec "NODE_PATH=#{NODE_MODULES_PATH} " \
      "WEBPACK_ENTRY_DIRS=#{WEBPACK_ENTRY_DIRS * ','} " \
      "#{WEBPACK_BIN} --progress --color " \
      "--config #{DEV_SERVER_CONFIG} --content-base #{PACKS_PATH} " \
      "#{ARGV.join(" ")}"
  end
end
